(function(A){A.widget("ui.colorpicker",{init:function(){this.charMin=65;var D=this.options,B=this,C='<div class="ui-colorpicker clearfix"><div class="ui-colorpicker-color"><div><div></div></div></div><div class="ui-colorpicker-hue"><div></div></div><div class="ui-colorpicker-new-color"></div><div class="ui-colorpicker-current-color"></div><div class="ui-colorpicker-hex"><label for="ui-colorpicker-hex" title="hex">#</label><input type="text" maxlength="6" size="6" /></div><div class="ui-colorpicker-rgb-r ui-colorpicker-field"><label for="ui-colorpicker-rgb-r">R</label><input type="text" maxlength="3" size="3" /><span></span></div><div class="ui-colorpicker-rgb-g ui-colorpicker-field"><label for="ui-colorpicker-rgb-g">G</label><input type="text" maxlength="3" size="3" /><span></span></div><div class="ui-colorpicker-rgb-b ui-colorpicker-field"><label for="ui-colorpicker-rgb-b">B</label><input type="text" maxlength="3" size="3" /><span></span></div><div class="ui-colorpicker-hsb-h ui-colorpicker-field"><label for="ui-colorpicker-hsb-h">H</label><input type="text" maxlength="3" size="3" /><span></span></div><div class="ui-colorpicker-hsb-s ui-colorpicker-field"><label for="ui-colorpicker-hsb-s">S</label><input type="text" maxlength="3" size="3" /><span></span></div><div class="ui-colorpicker-hsb-b ui-colorpicker-field"><label for="ui-colorpicker-hsb-b">B</label><input type="text" maxlength="3" size="3" /><span></span></div><button class="ui-colorpicker-submit ui-default-state" name="submit" type="submit">Done</button></div>';if(typeof D.color=="string"){this.color=this.HexToHSB(D.color)}else{if(D.color.r!=undefined&&D.color.g!=undefined&&D.color.b!=undefined){this.color=this.RGBToHSB(D.color)}else{if(D.color.h!=undefined&&D.color.s!=undefined&&D.color.b!=undefined){this.color=this.fixHSB(D.color)}else{return this}}}this.origColor=this.color;this.picker=A(C);if(D.flat){this.picker.appendTo(this.element).show()}else{this.picker.appendTo(document.body)}this.fields=this.picker.find("input").bind("keydown",function(E){return B.keyDown.call(B,E)}).bind("change",function(E){return B.change.call(B,E)}).bind("blur",function(E){return B.blur.call(B,E)}).bind("focus",function(E){return B.focus.call(B,E)});this.picker.find("span").bind("mousedown",function(E){return B.downIncrement.call(B,E)});this.selector=this.picker.find("div.ui-colorpicker-color").bind("mousedown",function(E){return B.downSelector.call(B,E)});this.selectorIndic=this.selector.find("div div");this.hue=this.picker.find("div.ui-colorpicker-hue div");this.picker.find("div.ui-colorpicker-hue").bind("mousedown",function(E){return B.downHue.call(B,E)});this.newColor=this.picker.find("div.ui-colorpicker-new-color");this.currentColor=this.picker.find("div.ui-colorpicker-current-color");this.picker.find("div.ui-colorpicker-submit").bind("mouseenter",function(E){return B.enterSubmit.call(B,E)}).bind("mouseleave",function(E){return B.leaveSubmit.call(B,E)}).bind("click",function(E){return B.clickSubmit.call(B,E)});this.fillRGBFields(this.color);this.fillHSBFields(this.color);this.fillHexFields(this.color);this.setHue(this.color);this.setSelector(this.color);this.setCurrentColor(this.color);this.setNewColor(this.color);if(D.flat){this.picker.css({position:"relative",display:"block"})}else{A(this.element).bind(D.eventName+".colorpicker",function(E){return B.show.call(B,E)})}},destroy:function(){this.picker.remove();this.element.removeData("colorpicker").unbind(".colorpicker")},fillRGBFields:function(B){var C=this.HSBToRGB(B);this.fields.eq(1).val(C.r).end().eq(2).val(C.g).end().eq(3).val(C.b).end()},fillHSBFields:function(B){this.fields.eq(4).val(B.h).end().eq(5).val(B.s).end().eq(6).val(B.b).end()},fillHexFields:function(B){this.fields.eq(0).val(this.HSBToHex(B)).end()},setSelector:function(B){this.selector.css("backgroundColor","#"+this.HSBToHex({h:B.h,s:100,b:100}));this.selectorIndic.css({left:parseInt(150*B.s/100,10),top:parseInt(150*(100-B.b)/100,10)})},setHue:function(B){this.hue.css("top",parseInt(150-150*B.h/360,10))},setCurrentColor:function(B){this.currentColor.css("backgroundColor","#"+this.HSBToHex(B))},setNewColor:function(B){this.newColor.css("backgroundColor","#"+this.HSBToHex(B))},keyDown:function(B){var C=B.charCode||B.keyCode||-1;if((C>=this.charMin&&C<=90)||C==32){return false}},change:function(D,C){var B;C=C||D.target;if(C.parentNode.className.indexOf("-hex")>0){this.color=B=this.HexToHSB(this.value);this.fillRGBFields(B.color);this.fillHSBFields(B)}else{if(C.parentNode.className.indexOf("-hsb")>0){this.color=B=this.fixHSB({h:parseInt(this.fields.eq(4).val(),10),s:parseInt(this.fields.eq(5).val(),10),b:parseInt(this.fields.eq(6).val(),10)});this.fillRGBFields(B);this.fillHexFields(B)}else{this.color=B=this.RGBToHSB(this.fixRGB({r:parseInt(this.fields.eq(1).val(),10),g:parseInt(this.fields.eq(2).val(),10),b:parseInt(this.fields.eq(3).val(),10)}));this.fillHexFields(B);this.fillHSBFields(B)}}this.setSelector(B);this.setHue(B);this.setNewColor(B);this.trigger("change",D,{options:this.options,hsb:B,hex:this.HSBToHex(B),rgb:this.HSBToRGB(B)})},blur:function(C){var B=this.color;this.fillRGBFields(B);this.fillHSBFields(B);this.fillHexFields(B);this.setHue(B);this.setSelector(B);this.setNewColor(B);this.fields.parent().removeClass("ui-colorpicker-focus")},focus:function(B){this.charMin=B.target.parentNode.className.indexOf("-hex")>0?70:65;this.fields.parent().removeClass("ui-colorpicker-focus");A(B.target.parentNode).addClass("ui-colorpicker-focus")},downIncrement:function(D){var C=A(D.target).parent().find("input").focus(),B=this;this.currentIncrement={el:A(D.target).parent().addClass("ui-colorpicker-slider"),max:D.target.parentNode.className.indexOf("-hsb-h")>0?360:(D.target.parentNode.className.indexOf("-hsb")>0?100:255),y:D.pageY,field:C,val:parseInt(C.val(),10)};A(document).bind("mouseup.cpSlider",function(E){return B.upIncrement.call(B,E)});A(document).bind("mousemove.cpSlider",function(E){return B.moveIncrement.call(B,E)});return false},moveIncrement:function(B){this.currentIncrement.field.val(Math.max(0,Math.min(this.currentIncrement.max,parseInt(this.currentIncrement.val+B.pageY-this.currentIncrement.y,10))));this.change.apply(this,[B,this.currentIncrement.field.get(0)]);return false},upIncrement:function(B){this.currentIncrement.el.removeClass("ui-colorpicker-slider").find("input").focus();this.change.apply(this,[B,this.currentIncrement.field.get(0)]);A(document).unbind("mouseup.cpSlider");A(document).unbind("mousemove.cpSlider");return false},downHue:function(C){this.currentHue={y:this.picker.find("div.ui-colorpicker-hue").offset().top};this.change.apply(this,[C,this.fields.eq(4).val(parseInt(360*(150-Math.max(0,Math.min(150,(C.pageY-this.currentHue.y))))/150,10)).get(0)]);var B=this;A(document).bind("mouseup.cpSlider",function(D){return B.upHue.call(B,D)});A(document).bind("mousemove.cpSlider",function(D){return B.moveHue.call(B,D)});return false},moveHue:function(B){this.change.apply(this,[B,this.fields.eq(4).val(parseInt(360*(150-Math.max(0,Math.min(150,(B.pageY-this.currentHue.y))))/150,10)).get(0)]);return false},upHue:function(B){A(document).unbind("mouseup.cpSlider");A(document).unbind("mousemove.cpSlider");return false},downSelector:function(C){var B=this;this.currentSelector={pos:this.picker.find("div.ui-colorpicker-color").offset()};this.change.apply(this,[C,this.fields.eq(6).val(parseInt(100*(150-Math.max(0,Math.min(150,(C.pageY-this.currentSelector.pos.top))))/150,10)).end().eq(5).val(parseInt(100*(Math.max(0,Math.min(150,(C.pageX-this.currentSelector.pos.left))))/150,10)).get(0)]);A(document).bind("mouseup.cpSlider",function(D){return B.upSelector.call(B,D)});A(document).bind("mousemove.cpSlider",function(D){return B.moveSelector.call(B,D)});return false},moveSelector:function(B){this.change.apply(this,[B,this.fields.eq(6).val(parseInt(100*(150-Math.max(0,Math.min(150,(B.pageY-this.currentSelector.pos.top))))/150,10)).end().eq(5).val(parseInt(100*(Math.max(0,Math.min(150,(B.pageX-this.currentSelector.pos.left))))/150,10)).get(0)]);return false},upSelector:function(B){A(document).unbind("mouseup.cpSlider");A(document).unbind("mousemove.cpSlider");return false},enterSubmit:function(B){this.picker.find("div.ui-colorpicker-submit").addClass("ui-colorpicker-focus")},leaveSubmit:function(B){this.picker.find("div.ui-colorpicker-submit").removeClass("ui-colorpicker-focus")},clickSubmit:function(C){var B=this.color;this.origColor=B;this.setCurrentColor(B);this.trigger("submit",C,{options:this.options,hsb:B,hex:this.HSBToHex(B),rgb:this.HSBToRGB(B)});return false},show:function(F){this.trigger("beforeShow",F,{options:this.options,hsb:this.color,hex:this.HSBToHex(this.color),rgb:this.HSBToRGB(this.color)});var G=this.element.offset();var E=this.getScroll();var D=G.top+this.element[0].offsetHeight;var C=G.left;if(D+176>E.t+Math.min(E.h,E.ih)){D-=this.element[0].offsetHeight+176}if(C+356>E.l+Math.min(E.w,E.iw)){C-=356}this.picker.css({left:C+"px",top:D+"px"});if(this.trigger("show",F,{options:this.options,hsb:this.color,hex:this.HSBToHex(this.color),rgb:this.HSBToRGB(this.color)})!=false){this.picker.show()}var B=this;A(document).bind("mousedown.colorpicker",function(H){return B.hide.call(B,H)});return false},hide:function(B){if(!this.isChildOf(this.picker[0],B.target,this.picker[0])){if(this.trigger("hide",B,{options:this.options,hsb:this.color,hex:this.HSBToHex(this.color),rgb:this.HSBToRGB(this.color)})!=false){this.picker.hide()}A(document).unbind("mousedown.colorpicker")}},isChildOf:function(D,C,B){if(D==C){return true}if(D.contains&&!A.browser.safari){return D.contains(C)}if(D.compareDocumentPosition){return !!(D.compareDocumentPosition(C)&16)}var E=C.parentNode;while(E&&E!=B){if(E==D){return true}E=E.parentNode}return false},getScroll:function(){var E,C,B,F,D,G;if(document.documentElement){E=document.documentElement.scrollTop;C=document.documentElement.scrollLeft;B=document.documentElement.scrollWidth;F=document.documentElement.scrollHeight}else{E=document.body.scrollTop;C=document.body.scrollLeft;B=document.body.scrollWidth;F=document.body.scrollHeight}D=self.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0;G=self.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0;return{t:E,l:C,w:B,h:F,iw:D,ih:G}},fixHSB:function(B){return{h:Math.min(360,Math.max(0,B.h)),s:Math.min(100,Math.max(0,B.s)),b:Math.min(100,Math.max(0,B.b))}},fixRGB:function(B){return{r:Math.min(255,Math.max(0,B.r)),g:Math.min(255,Math.max(0,B.g)),b:Math.min(255,Math.max(0,B.b))}},HexToRGB:function(B){var B=parseInt(((B.indexOf("#")>-1)?B.substring(1):B),16);return{r:B>>16,g:(B&65280)>>8,b:(B&255)}},HexToHSB:function(B){return this.RGBToHSB(this.HexToRGB(B))},RGBToHSB:function(C){var B={};B.b=Math.max(Math.max(C.r,C.g),C.b);B.s=(B.b<=0)?0:Math.round(100*(B.b-Math.min(Math.min(C.r,C.g),C.b))/B.b);B.b=Math.round((B.b/255)*100);if((C.r==C.g)&&(C.g==C.b)){B.h=0}else{if(C.r>=C.g&&C.g>=C.b){B.h=60*(C.g-C.b)/(C.r-C.b)}else{if(C.g>=C.r&&C.r>=C.b){B.h=60+60*(C.g-C.r)/(C.g-C.b)}else{if(C.g>=C.b&&C.b>=C.r){B.h=120+60*(C.b-C.r)/(C.g-C.r)}else{if(C.b>=C.g&&C.g>=C.r){B.h=180+60*(C.b-C.g)/(C.b-C.r)}else{if(C.b>=C.r&&C.r>=C.g){B.h=240+60*(C.r-C.g)/(C.b-C.g)}else{if(C.r>=C.b&&C.b>=C.g){B.h=300+60*(C.r-C.b)/(C.r-C.g)}else{B.h=0}}}}}}}B.h=Math.round(B.h);return B},HSBToRGB:function(B){var D={};var H=Math.round(B.h);var G=Math.round(B.s*255/100);var C=Math.round(B.b*255/100);if(G==0){D.r=D.g=D.b=C}else{var I=C;var F=(255-G)*C/255;var E=(I-F)*(H%60)/60;if(H==360){H=0}if(H<60){D.r=I;D.b=F;D.g=F+E}else{if(H<120){D.g=I;D.b=F;D.r=I-E}else{if(H<180){D.g=I;D.r=F;D.b=F+E}else{if(H<240){D.b=I;D.r=F;D.g=I-E}else{if(H<300){D.b=I;D.g=F;D.r=F+E}else{if(H<360){D.r=I;D.g=F;D.b=I-E}else{D.r=0;D.g=0;D.b=0}}}}}}}return{r:Math.round(D.r),g:Math.round(D.g),b:Math.round(D.b)}},RGBToHex:function(B){var C=[B.r.toString(16),B.g.toString(16),B.b.toString(16)];A.each(C,function(D,E){if(E.length==1){C[D]="0"+E}});return C.join("")},HSBToHex:function(B){return this.RGBToHex(this.HSBToRGB(B))},setColor:function(B){if(typeof B=="string"){B=this.HexToHSB(B)}else{if(B.r!=undefined&&B.g!=undefined&&B.b!=undefined){B=this.RGBToHSB(B)}else{if(B.h!=undefined&&B.s!=undefined&&B.b!=undefined){B=this.fixHSB(B)}else{return this}}}this.color=B;this.origColor=B;this.fillRGBFields(B);this.fillHSBFields(B);this.fillHexFields(B);this.setHue(B);this.setSelector(B);this.setCurrentColor(B);this.setNewColor(B)}});A.extend(A.ui.colorpicker,{defaults:{eventName:"click",color:"ff0000",flat:false}})})(jQuery)